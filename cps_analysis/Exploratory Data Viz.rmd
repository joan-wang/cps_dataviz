---
title: "Exploratory Data Visualizations"
author: "Joan Wang"
date: "October 22, 2017"
output: 
  html_document: 
  fig_caption: false
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r error=FALSE, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
library(tidyverse)
library(reshape2)
library(viridis)
library(ggplot2)

# define theme
windowsFonts(YuGothic=windowsFont("Yu Gothic"))
windowsFonts(YuGothicSemibold=windowsFont("Yu Gothic UI Semibold"))
mytheme <- theme(panel.background = element_rect(fill = 'gray95'), 
                 panel.grid.major = element_blank(),
                 panel.grid.minor = element_blank(), 
                 text = element_text(size=12, family="YuGothicSemibold", color='#34495E'),
                 strip.text = element_text(size=8, family="YuGothic"),
                 plot.title = element_text(size = 14, face = "bold"),
                 plot.subtitle = element_text(size = 12, face = "bold"),
                 plot.caption = element_text(size=8, color='grey60')
                 )
my_palette <- c('#FECEA8', '#A1BBD0', '#D1A827', '#687672', '#3F4234')
my_gradient <- c(low='#566573', high='#17202A')

profile <- read_csv('../cps_data/Profile_1617.csv')

combined_1617 <- read_csv('../cps_data/Combined_1617.csv')
combined_1617[combined_1617 == 'NO DATA AVAILBLE'] <- NA
combined_1617[combined_1617 == 'NOT ENOUGH DATA'] <- NA
combined_1617$School_Survey_Safety <- factor(combined_1617$School_Survey_Safety, levels = c('VERY WEAK', 'WEAK', 'NEUTRAL', 'STRONG', 'VERY STRONG'))
combined_1617$Zip <- factor(combined_1617$Zip)

schools_crimes <- read_csv('schools_crimes.csv')
```

### Density Plots: Distribution of Attendance Rates by Safety Rating
```{r error=FALSE, warning=FALSE, message=FALSE}
ggplot(subset(combined_1617, !is.na(School_Survey_Safety)), aes(x=Student_Attendance_Year_2_Pct, color = School_Survey_Safety, fill=School_Survey_Safety)) +
  geom_density() + 
  scale_fill_manual(values=my_palette, guide = FALSE) + 
  scale_color_manual(values=my_palette, guide = FALSE) + 
  facet_wrap(~ School_Survey_Safety, ncol=1) + 
  labs(title = "Attendance tends to be higher at schools where students feel safe",
       subtitle = "Distribution of elementary school attendance rates by safety rating*",
       x = "Student Attendance",
       y = "Density",
       caption = "Source: Chicago Public Schools - School Progress Reports SY1617\n *Safety ratings based on student survey") +
  mytheme
```

Not every student feels safe at school. The 5 Essentials Survey administered annually to CPS students measures student' perception of safety, rating each school on a scale of "very weak" to "very strong." Results from the 2016-2017 school year suggest that schools with weaker safety ratings also face lower student attendance. 

### Density Plots: Distribution of Attainment Percentiles by Safety Rating
```{r error=FALSE, warning=FALSE, message=FALSE}
ggplot(subset(filter(combined_1617, Primary_Category == "ES"), !is.na(School_Survey_Safety)), aes(x=Attainment_Reading_Pct_ES, color = School_Survey_Safety, fill=School_Survey_Safety)) +
  geom_density() + 
  scale_fill_manual(values=my_palette, guide = FALSE) + 
  scale_color_manual(values=my_palette, guide = FALSE) + 
  facet_wrap(~ School_Survey_Safety, ncol=1) + 
  labs(title = "Attainment tends to be higher at schools where students feel safe",
       subtitle = "Distribution of elementary school reading attainment percentiles by safety rating*",
       x = "Student Reading Attainment (Percentile of National Average)",
       y = "Density",
       caption = "Source: Chicago Public Schools - School Progress Reports SY1617\n *Safety ratings based on student survey") +
  mytheme
```

Students' sense of school safety not only affects their attendance, but also their performance. Elementary schools with weak safety survey ratings performed worse on standardized reading tests than those with strong safety ratings. Whether directly or indirectly, unsafe school environments could be a contributing factor to negative student outcomes. 

### Boxplot: Crimes in Vicinity by Safety Rating
```{r error=FALSE, warning=FALSE, message=FALSE}
combined_1617_crimes <- inner_join(combined_1617, schools_crimes, by="School_ID")
ggplot(subset(combined_1617_crimes, !is.na(School_Survey_Safety)), aes(x=School_Survey_Safety, y=num_crimes_16, fill=School_Survey_Safety)) +
  scale_fill_manual(values=my_palette) + 
  geom_boxplot() + 
  guides(fill=FALSE) + 
  labs(title = "Students feel more unsafe at school in high-crime neighborhoods",
       subtitle = "Schools with weaker safety ratings face higher number of crimes \nwithin 1 mile radius of campus",
       x = "Safety Rating*",
       y = "Number of Crimes in School Vicinity",
       caption = "Source: Chicago Public Schools - School Progress Reports SY1617\n Chicago Police Department - Crimes 2016\n *Safety ratings based on student survey") + 
  mytheme
```

Many instances of crime happen close to school grounds. On average, ~4000 crimes were reported within a 1 mile radius of each CPS school in 2016. Schools with weaker safety ratings had more crime incidents reported within their vicinity. These nearby crimes rates could influence students' perception of safety at their schools.

### Scatter: Percent Low Income Students vs. Crimes in Vicinity
```{r error=FALSE, warning=FALSE, message=FALSE}
profile <- mutate(profile, perc_lowincome = Student_Count_Low_Income / Student_Count_Total)
subset(combined_1617_crimes, !is.na(School_Survey_Safety)) %>%
  merge(profile, by="School_ID") %>%
  ggplot(aes(x = perc_lowincome, y = num_crimes_16)) +
    geom_point(aes(color = School_Survey_Safety)) +
    geom_smooth(model = lm) + 
    scale_x_continuous(labels = scales::percent) + 
    scale_color_manual(name="Safety Rating\n(based on student survey)", values = my_palette) + 
    labs(title = "Low income students attend schools in highest-crime neighborhoods ",
         subtitle = "Schools with higher percent of low income students see higher number of crimes wtihin 1 mile radius",
         x = "Percent Low Income Students",
         y = "Number of Crimes in School Vicinity",
         caption = "Source: Chicago Public Schools - School Progress Reports SY1617\n Chicago Police Department - Crimes 2016") + 
    mytheme
```

Low-income students are attending the schools with the highest rates of nearby crime. The steep slope at the rightmost side of curve fitted to the above scatterplot suggests that the schools surrounded by the most crime also have the highest proportion of low-income students. 

### Heat Map: Perception of School Safety by Zip Code
```{r error=FALSE, warning=FALSE, message=FALSE,fig.width=8,fig.height=11}
combined_1617 %>%
  subset(!is.na(School_Survey_Safety)) %>%
  group_by(Zip, School_Survey_Safety) %>%
  summarize(num_schools=n(), na.rm = TRUE) %>% 
  mutate(prop_schools = num_schools/sum(num_schools)) %>%
  ggplot(aes(x=School_Survey_Safety, y=Zip, fill=prop_schools)) + 
  geom_tile() + 
  scale_fill_gradient(name = 'Proportion of Schools\n in Zip Code\n', low='#AEB6BF', high='#17202A') + 
  labs(title = "Students' perception of school safety varies between zip codes",
       x = "Safety Rating*",
       y = "Zip Code",
       caption = "Source: Chicago Public Schools - School Progress Reports SY1617\n *Safety ratings based on student survey") + 
  mytheme
```

Who are these students who are most affected by these unsafe school environments? This preliminary heat map suggests that school safety perceptions vary by zip code. In future visualizations, we will continue to explore this topic from a geographical context. 



